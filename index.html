<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Plan de Vuelo</title>
  <style>
    :root{--max-width:720px;--gap:12px;--accent:#0b5fff}
    *,*::before,*::after{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;line-height:1.4;background:#f7f9fc;color:#0b1b2a;padding:16px}
    .container{max-width:var(--max-width);margin:0 auto;background:#fff;padding:18px;border-radius:10px;box-shadow:0 6px 18px rgba(9,30,66,.08)}
    h1{font-size:1.25rem;margin:0 0 12px}
    form{display:flex;flex-direction:column;gap:var(--gap)}
    .form-group{display:flex;flex-direction:column}
    label{font-weight:600;font-size:.95rem;margin-bottom:6px}
    input[type="text"], input[type="tel"], input[type="time"]{padding:12px 14px;font-size:1rem;border:1px solid #d7e0ea;border-radius:10px;width:100%}
      input[type="text"], input[type="tel"], input[type="time"], select{padding:12px 14px;font-size:1rem;border:1px solid #d7e0ea;border-radius:10px;width:100%}
    button[type="submit"], .btn{background:var(--accent);color:#fff;border:none;padding:12px 14px;border-radius:10px;font-size:1rem;cursor:pointer}
    button[type="submit"]:active, .btn:active{transform:translateY(1px)}
    .btn{background:#666;margin-right:8px}
    .btn:last-child{margin-right:0}
    .button-group{display:flex;gap:8px;flex-wrap:wrap}
    .actions{display:flex;justify-content:flex-end}
    #signaturePad{border:2px solid #d7e0ea;border-radius:10px;display:block;width:100%;height:200px;touch-action:none;background:#f9f9f9}
    .signature-container{display:flex;flex-direction:column}
    @media(min-width:600px){
      form .two-col{display:grid;grid-template-columns:1fr 1fr;gap:var(--gap)}
      h1{font-size:1.5rem}
      .actions{justify-content:flex-end}
    }
    @media(max-width:599px){
      button[type="submit"]{width:100%}
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Plan de vuelo para planeadores</h1>
    <form id="pdfForm" aria-label="Formulario plan de vuelo">
      <div class="form-group">
        <label for="FlightType">Tipo de Vuelo</label>
        <select id="FlightType" name="FlightType" aria-label="Tipo de vuelo">
          <option value="vuelo_local" selected>Vuelo Local</option>
          <option value="vuelo_deportivo">Vuelo Deportivo</option>
        </select>
      </div>

      <div class="two-col">
        <div class="form-group">
          <label for="Identification">Aircraft Identification</label>
          <input type="text" id="Identification" name="Identification" autocomplete="off" placeholder="Sin incluir LV-" aria-required="true" />
        </div>
        <div class="form-group">
          <label for="Time">Time</label>
          <input type="text" id="Time" name="Time" autocomplete="off" placeholder="HHMM (Ej: 1230)" aria-required="true" />
        </div>
      </div>

      <div class="form-group">
        <label for="Other">SOLO PARA VUELO DEPORTIVO</label>
        <label for="Other">Other - Vertical de (Opcional)</label>
        <input type="text" id="Other" name="Other" placeholder="(Ej: Bigand)" />
      </div>

      <div class="form-group">
        <label for="Day">Other - Day of Flight (Opcional)</label>
        <input type="text" id="Day" name="Day" placeholder="AAMMDD (Ej: 260216)" />
      </div>

      <div class="form-group">
        <label for="Persons">Persons on Board</label>
          <select id="Persons" name="Persons" aria-label="Persons on Board">
            <option value="1">1</option>
            <option value="2">2</option>
          </select>
      </div>

      <div class="form-group">
        <label for="Colour">Aircraft Colours and Markings</label>
        <input type="text" id="Colour" name="Colour" placeholder="Color y detalles" />
      </div>

      <div class="form-group">
        <label for="Phone">Remark - Celular</label>
        <input type="tel" id="Phone" name="Phone" inputmode="tel" placeholder="341-6123456" />
      </div>

      <div class="form-group">
        <label for="Pilot">Pilot in Command</label>
        <input type="text" id="Pilot" name="Pilot" placeholder="Solo nombre y apellido del piloto" />
      </div>

      <div class="form-group">
        <label for="PilotDNI">DNI del Piloto</label>
        <input type="text" id="PilotDNI" name="PilotDNI" placeholder="DNI del piloto" />
      </div>

      <div class="form-group signature-container">
        <label for="signaturePad">Firma del Piloto (toca para firmar)</label>
        <canvas id="signaturePad"></canvas>
        <div class="button-group" style="margin-top:8px">
          <button type="button" class="btn" id="clearSignature">Limpiar firma</button>
          <button type="button" class="btn" id="saveSignature" style="background:#28a745">Confirmar firma</button>
        </div>
      </div>

      <div class="form-group">
        <label id="signatureStatus" style="font-size:0.9rem;color:#666">Estado: No firmado</label>
      </div>

      <div class="actions">
        <button type="submit">Generar PDF</button>
      </div>
    </form>
  </div>

  <script type="module">
    import { PDFDocument } from 'https://cdn.skypack.dev/pdf-lib';

    // Configuración del canvas para firma
    const canvas = document.getElementById('signaturePad');
    const ctx = canvas.getContext('2d');
    let isDrawing = false;
    let signatureData = null;

    // Ajustar tamaño del canvas
    function resizeCanvas() {
      canvas.width = canvas.offsetWidth;
      canvas.height = canvas.offsetHeight;
      ctx.fillStyle = '#f9f9f9';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.strokeStyle = '#000';
      ctx.lineWidth = 2;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
    }
    resizeCanvas();

    // Función para obtener coordenadas
    function getCoordinates(e) {
      const rect = canvas.getBoundingClientRect();
      if (e.touches) {
        return { x: e.touches[0].clientX - rect.left, y: e.touches[0].clientY - rect.top };
      } else {
        return { x: e.clientX - rect.left, y: e.clientY - rect.top };
      }
    }

    // Eventos de dibujo
    canvas.addEventListener('pointerdown', (e) => {
      isDrawing = true;
      const { x, y } = getCoordinates(e);
      ctx.beginPath();
      ctx.moveTo(x, y);
    });

    canvas.addEventListener('pointermove', (e) => {
      if (!isDrawing) return;
      const { x, y } = getCoordinates(e);
      ctx.lineTo(x, y);
      ctx.stroke();
    });

    canvas.addEventListener('pointerup', () => {
      isDrawing = false;
    });

    canvas.addEventListener('pointerleave', () => {
      isDrawing = false;
    });

    // Limpiar firma
    document.getElementById('clearSignature').addEventListener('click', (e) => {
      e.preventDefault();
      ctx.fillStyle = '#f9f9f9';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      signatureData = null;
      document.getElementById('signatureStatus').textContent = 'Estado: No firmado';
      document.getElementById('saveSignature').style.background = '#28a745';
    });

    // Guardar firma
    document.getElementById('saveSignature').addEventListener('click', (e) => {
      e.preventDefault();
      signatureData = canvas.toDataURL('image/png');
      document.getElementById('signatureStatus').textContent = 'Estado: ✓ Firmado';
      document.getElementById('saveSignature').style.background = '#0b5fff';
    });

    document.getElementById('pdfForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const IdentificationRaw = document.getElementById('Identification').value.split('');
      const Identification = IdentificationRaw.join('  ');
      const TimeRaw = document.getElementById('Time').value.split('');
      const Time = TimeRaw.join('  ');
      const FlightType = document.getElementById('FlightType').value;
      const pdfPath = FlightType === 'vuelo_deportivo' ? 'formularioDeportivo.pdf' : 'formulario.pdf';
      const DayRaw = document.getElementById('Day').value;
      const Day = DayRaw ? ' DOF/' + DayRaw : '';
      const OtherRaw = FlightType === 'vuelo_deportivo' ? document.getElementById('Other').value : '';
      const Other = Day ? OtherRaw + Day : OtherRaw;
      const Persons = document.getElementById('Persons').value;
      const Colour = document.getElementById('Colour').value;
      const Phone = document.getElementById('Phone').value;
      const Pilot = document.getElementById('Pilot').value;
      const PilotDNI = document.getElementById('PilotDNI').value;
      const signature = signatureData;

      // Intentar cargar PDF base
      try {
        const existingPdfBytes = await fetch(pdfPath).then(res => {
          if (!res.ok) throw new Error('No se pudo obtener ' + pdfPath);
          return res.arrayBuffer();
        });
        const pdfDoc = await PDFDocument.load(existingPdfBytes);
        const form = pdfDoc.getForm();
        const pages = pdfDoc.getPages();
        const firstPage = pages[0];

        // Intenta rellenar campos si existen
        try { form.getTextField('Identification').setText(Identification); } catch(e){}
        try { form.getTextField('Time').setText(Time); } catch(e){}
        try { form.getTextField('Other').setText(Other); } catch(e){}
        try { form.getTextField('Other').setText(Other); } catch(e){}
        try { form.getTextField('Persons').setText(Persons); } catch(e){}
        try { form.getTextField('Colour').setText(Colour); } catch(e){}
        try { form.getTextField('Phone').setText(Phone); } catch(e){}
        try { form.getTextField('Pilot').setText(Pilot + " " + PilotDNI); } catch(e){}
        
        // Tratar campo de firma como imagen si existe
        if (signature) {
          try {
            const signatureField = form.getTextField('Signature');
            signatureField.setText('');
          } catch(e){}
          try {
            const signatureImage = await pdfDoc.embedPng(signature);
            firstPage.drawImage(signatureImage, { x: 40, y: 100, width: 150, height: 60 });
          } catch(e){}
        } else {
          try { form.getTextField('Signature').setText(Pilot); } catch(e){}
        }

        const pdfBytes = await pdfDoc.save();
        const blob = new Blob([pdfBytes], { type: 'application/pdf' });
        const url = URL.createObjectURL(blob);
        window.open(url);
        return;
      } catch (err) {
        // Fallback: crear PDF sencillo
        try {
          const pdfDoc = await PDFDocument.create();
          const page = pdfDoc.addPage([595, 842]);
          const fontSize = 12;
          const left = 40;
          let y = 780;
          page.drawText(`Aircraft Identification: ${Identification}`, { x: left, y, size: fontSize }); y -= 24;
          page.drawText(`Time: ${Time}`, { x: left, y, size: fontSize }); y -= 20;
          page.drawText(`Other: ${Other}`, { x: left, y, size: fontSize }); y -= 20;
          page.drawText(`Persons on Board: ${Persons}`, { x: left, y, size: fontSize }); y -= 20;
          page.drawText(`Colours/Markings: ${Colour}`, { x: left, y, size: fontSize }); y -= 20;
          page.drawText(`Remark (Celular): ${Phone}`, { x: left, y, size: fontSize }); y -= 20;
          page.drawText(`Pilot in Command: ${Pilot + " " + PilotDNI}`, { x: left, y, size: fontSize }); y -= 20;
          page.drawText(`Signature:`, { x: left, y, size: fontSize }); 
          
          // Agregar firma si existe
          if (signature) {
            try {
              const signatureImage = await pdfDoc.embedPng(signature);
              page.drawImage(signatureImage, { x: left, y: y - 80, width: 150, height: 60 });
            } catch(e) {
              page.drawText('(Firma firmada)', { x: left, y: y - 20, size: 10 });
            }
          }

          const pdfBytes = await pdfDoc.save();
          const blob = new Blob([pdfBytes], { type: 'application/pdf' });
          const url = URL.createObjectURL(blob);
          window.open(url);
          return;
        } catch (err2) {
          console.error('Error al generar PDF (fallback):', err2);
          alert('Error al generar PDF. Consulta la consola.');
        }
      }
    });
  </script>
</body>
</html>
